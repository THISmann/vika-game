input {
  beats {
    port => 5044
  }
}

filter {
  # Parser les logs JSON si disponibles
  if [message] =~ /^\{/ {
    json {
      source => "message"
    }
  }

  # Extraire les informations des logs Docker/containers
  if [container] {
    mutate {
      add_field => {
        "container_name" => "%{[container][name]}"
        "container_id" => "%{[container][id]}"
      }
    }
  }

  # Extraire les informations des logs Kubernetes si présents
  if [kubernetes] {
    mutate {
      add_field => {
        "namespace" => "%{[kubernetes][namespace]}"
        "pod_name" => "%{[kubernetes][pod][name]}"
        "container_name" => "%{[kubernetes][container][name]}"
      }
    }
  }

  # Parser les logs des endpoints critiques Game Service
  if [container][name] =~ /game-service/ or [container_name] =~ /game-service/ {
    # Parser les logs de réponse
    if [message] =~ /ANSWER QUESTION/ {
      grok {
        match => {
          "message" => [
            "Player: %{DATA:player_name} \(%{DATA:player_id}\)",
            "Question ID: %{DATA:question_id}",
            "Is correct: %{WORD:is_correct}",
            "Raw answer from player: \"%{DATA:player_answer}\"",
            "Raw correct answer: \"%{DATA:correct_answer}\""
          ]
        }
      }
      mutate {
        add_field => { "endpoint_type" => "answer" }
        add_field => { "critical_endpoint" => "true" }
        add_field => { "service" => "game-service" }
      }
    }
    
    # Parser les logs de démarrage de jeu
    if [message] =~ /GAME STARTED/ {
      grok {
        match => {
          "message" => [
            "Game started with %{NUMBER:question_count:int} questions",
            "Question duration: %{NUMBER:question_duration:int} seconds"
          ]
        }
      }
      mutate {
        add_field => { "endpoint_type" => "start_game" }
        add_field => { "critical_endpoint" => "true" }
        add_field => { "service" => "game-service" }
      }
    }
    
    # Parser les logs de score
    if [message] =~ /UPDATE SCORE/ {
      grok {
        match => {
          "message" => [
            "Player: %{DATA:player_name} \(%{DATA:player_id}\)",
            "Delta: %{NUMBER:score_delta:int}",
            "Score updated: %{DATA:player_name} \(%{DATA:player_id}\) = %{NUMBER:player_score:int}"
          ]
        }
      }
      mutate {
        add_field => { "endpoint_type" => "score_update" }
        add_field => { "critical_endpoint" => "true" }
        add_field => { "service" => "game-service" }
      }
    }
    
    # Parser les logs HTTP
    grok {
      match => {
        "message" => [
          "%{WORD:http_method} %{URIPATH:http_path}.*%{NUMBER:http_status:int}",
          "POST /game/answer.*%{NUMBER:http_status:int}",
          "GET /game/score/%{DATA:player_id}.*%{NUMBER:http_status:int}",
          "GET /game/leaderboard.*%{NUMBER:http_status:int}",
          "POST /game/start.*%{NUMBER:http_status:int}",
          "POST /game/next.*%{NUMBER:http_status:int}",
          "POST /game/end.*%{NUMBER:http_status:int}",
          "GET /game/results.*%{NUMBER:http_status:int}"
        ]
      }
    }
    
    # Identifier les endpoints critiques
    if [http_path] =~ /^\/game\/(answer|start|next|end|results|leaderboard|score)/ {
      mutate {
        add_field => { "critical_endpoint" => "true" }
        add_field => { "service" => "game-service" }
      }
    }
  }

  # Parser les logs Auth Service
  if [container][name] =~ /auth-service/ or [container_name] =~ /auth-service/ {
    grok {
      match => {
        "message" => [
          "POST /auth/admin/login.*%{NUMBER:http_status:int}",
          "POST /auth/players/register.*%{NUMBER:http_status:int}",
          "GET /auth/players.*%{NUMBER:http_status:int}",
          "GET /auth/players/%{DATA:player_id}.*%{NUMBER:http_status:int}"
        ]
      }
    }
    
    if [message] =~ /(?i)(login|register|authentication)/ {
      grok {
        match => {
          "message" => [
            "Player registered: %{DATA:player_name} \(%{DATA:player_id}\)",
            "Admin login: %{DATA:username}",
            "Token generated for: %{DATA:username}"
          ]
        }
      }
      mutate {
        add_field => { "endpoint_type" => "auth" }
        add_field => { "critical_endpoint" => "true" }
        add_field => { "service" => "auth-service" }
      }
    }
    
    if [http_path] =~ /^\/auth\/(admin\/login|players\/register|players)/ {
      mutate {
        add_field => { "critical_endpoint" => "true" }
        add_field => { "service" => "auth-service" }
      }
    }
  }

  # Parser les logs Quiz Service
  if [container][name] =~ /quiz-service/ or [container_name] =~ /quiz-service/ {
    grok {
      match => {
        "message" => [
          "GET /quiz/all.*%{NUMBER:http_status:int}",
          "GET /quiz/full.*%{NUMBER:http_status:int}",
          "POST /quiz/create.*%{NUMBER:http_status:int}",
          "PUT /quiz/%{DATA:question_id}.*%{NUMBER:http_status:int}",
          "DELETE /quiz/%{DATA:question_id}.*%{NUMBER:http_status:int}",
          "GET /quiz/verify/%{DATA:question_id}.*%{NUMBER:http_status:int}"
        ]
      }
    }
    
    if [message] =~ /(?i)(question|quiz|verify)/ {
      grok {
        match => {
          "message" => [
            "Question %{DATA:question_id} (created|updated|deleted)",
            "Verifying answer for question: %{DATA:question_id}"
          ]
        }
      }
      mutate {
        add_field => { "endpoint_type" => "quiz" }
        add_field => { "critical_endpoint" => "true" }
        add_field => { "service" => "quiz-service" }
      }
    }
    
    if [http_path] =~ /^\/quiz\/(all|full|create|verify|questions)/ {
      mutate {
        add_field => { "critical_endpoint" => "true" }
        add_field => { "service" => "quiz-service" }
      }
    }
  }

  # Parser les logs WebSocket
  if [message] =~ /(?i)(websocket|socket\.io|register|connected|disconnected|polling)/ {
    grok {
      match => {
        "message" => [
          "Socket ID: %{DATA:socket_id}",
          "Player ID: %{DATA:player_id}",
          "Connected: %{WORD:connected_status}",
          "Event: %{DATA:event_name}",
          "Transport: %{WORD:transport_type}",
          "Game Code: %{DATA:game_code}"
        ]
      }
    }
    mutate {
      add_field => { "endpoint_type" => "websocket" }
      add_field => { "critical_endpoint" => "true" }
    }
  }

  # Parser les logs de performance
  if [message] =~ /(?i)(duration|response time|latency|ms|seconds|took)/ {
    grok {
      match => {
        "message" => [
          "Duration: %{NUMBER:duration:float}%{WORD:duration_unit}",
          "Response time: %{NUMBER:response_time:float}ms",
          "Latency: %{NUMBER:latency:float}ms",
          "took %{NUMBER:duration_ms:int}ms"
        ]
      }
    }
    mutate {
      add_field => { "has_performance_metric" => "true" }
    }
  }

  # Parser les erreurs
  if [message] =~ /(?i)(error|❌|failed|exception|exception:|error:)/ {
    grok {
      match => {
        "message" => [
          "Error: %{GREEDYDATA:error_message}",
          "❌ %{GREEDYDATA:error_message}",
          "Exception: %{GREEDYDATA:error_message}",
          "Failed: %{GREEDYDATA:error_message}"
        ]
      }
    }
    mutate {
      add_field => { "log_level" => "error" }
      add_field => { "has_error" => "true" }
    }
  }

  # Parser les warnings
  if [message] =~ /(?i)(warn|warning|⚠)/ {
    mutate {
      add_field => { "log_level" => "warn" }
    }
  }

  # Parser les infos/success
  if [message] =~ /(?i)(info|✅|success|completed)/ {
    mutate {
      add_field => { "log_level" => "info" }
    }
  }

  # Normaliser le niveau de log
  if ![log_level] {
    if [message] =~ /(?i)(error|❌|failed|exception)/ {
      mutate {
        add_field => { "log_level" => "error" }
      }
    } else if [message] =~ /(?i)(warn|warning|⚠)/ {
      mutate {
        add_field => { "log_level" => "warn" }
      }
    } else if [message] =~ /(?i)(info|✅|success)/ {
      mutate {
        add_field => { "log_level" => "info" }
      }
    } else {
      mutate {
        add_field => { "log_level" => "debug" }
      }
    }
  }

  # Ajouter des tags pour faciliter les recherches
  if [critical_endpoint] == "true" {
    mutate {
      add_tag => [ "critical", "endpoint" ]
    }
  }

  if [log_level] == "error" {
    mutate {
      add_tag => [ "error", "alert" ]
    }
  }

  # Ajouter un timestamp si absent
  if ![timestamp] {
    date {
      match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss" ]
      target => "@timestamp"
    }
  }

  # Ajouter des métadonnées
  mutate {
    add_field => {
      "environment" => "docker"
      "log_source" => "docker-compose"
    }
  }
}

output {
  # Tous les logs vers l'index principal
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "gamev2-logs-%{+YYYY.MM.dd}"
  }
  
  # Logs d'erreur dans un index séparé
  if [log_level] == "error" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "gamev2-errors-%{+YYYY.MM.dd}"
    }
  }
  
  # Logs des endpoints critiques dans un index séparé
  if [critical_endpoint] == "true" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "gamev2-critical-%{+YYYY.MM.dd}"
    }
  }
  
  # Logs WebSocket dans un index séparé
  if [endpoint_type] == "websocket" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "gamev2-websocket-%{+YYYY.MM.dd}"
    }
  }
}

